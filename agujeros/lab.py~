import sys
from PIL import Image, ImageDraw, ImageOps

def grayScale(im):
    w,h = im.size
    gray = im.copy()
    pix = gray.load()
    for x in range(w):
        for y in range(h):
            curr = pix[x,y]
            #prom = (curr[0] + curr[1] + curr[2]) / 3
            prom = max(curr)
            pix[x,y] = prom, prom, prom
    return gray

def blur(im):
    w,h = im.size
    blurred = im.copy()
    pix = blurred.load()
    for x in range(w):
        for y in range(h):
            ngbs = []
            for i in range(x-1, x+2):
                for j in range(y-1, y+2):
                    try:
                        ngbs.append(pix[i,j])
                    except IndexError:
                        pass
            ngbs.sort()
            p = ngbs[len(ngbs)/2][0]
            #total = [ sum(z) for z in zip(*ngbs) ]
            pix[x,y] = p,p,p
            #total[0]/len(ngbs), total[1]/len(ngbs), total[2]/len(ngbs)
    return blurred

def horizontalHistogram(im):
    w,h = im.size
    pix = im.load()
    file_ = open('horizontal.txt', 'w')
    hist = []
    for x in range(w):
        temp = 0
        for y in range(h):
            temp += pix[x,y][0]
        file_.write(str(x)+ ' ' + str(temp) + '\n')
        hist.append(temp)
    file_.close()
    return hist

def verticalHistogram(im):
    w,h = im.size
    pix = im.load()
    file_ = open('vertical.txt', 'w')
    hist = []
    sum_ = 0
    for y in range(h):
        temp = 0
        for x in range(w):
            temp += pix[x,y][0]
        file_.write(str(x)+ ' ' + str(temp) + '\n')
        hist.append(temp)
    file_.close()
    return hist

def possibleHoles(hist):
    coord = []
    for i in range(1, len(hist) - 1):
        if hist[i-1] > hist[i] and hist[i+1] > hist[1]:
            coord.append(i)
    return coord

def holeDetection(im):
    size = 128,128
    original = im.copy()
    im.thumbnail(size, Image.ANTIALIAS)
    im = grayScale(im)
    im = blur(im)
    im.save('gray.png')
    histx = horizontalHistogram(im)
    histy = verticalHistogram(im)
    
    holex = possibleHoles(histx)
    draw = ImageDraw.Draw(original)

    prop = im.size
    prop = float(original.size[0])/prop[0] , float(original.size[1]/prop[1])
    w, h = original.size
    
    for i in holex:
        #print i
        x = int(i*prop[0])
        draw.line((x,0,x,h), fill='yellow')
    '''
    for i in histy:
        if i > promy:
            y = int(i*prop[1])
            print '0', y
            print w,y
            draw.line((0,y,w,y), fill=(255,0,0))
    '''
    #draw.line((0,w/2, w,w/5),fill='yellow')
    original.save('lineas.png')
    original.show()
    

if __name__ == '__main__':
    path = sys.argv[1]
    image = Image.open(path).convert('RGB')
    holeDetection(image)
